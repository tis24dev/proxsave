name: Security Scanning (GoSec)

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    - cron: '0 0 * * 1'  # ogni lunedì

permissions:
  contents: read
  security-events: write

jobs:
  gosec:
    name: Run GoSec Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # Install GoSec da source → più stabile e sempre aggiornato
      - name: Install GoSec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      # Analisi principale → SARIF valido (per GitHub Code Scanning)
      - name: Run GoSec (SARIF)
        run: |
          ~/go/bin/gosec -fmt sarif -out gosec-results.sarif ./...
        continue-on-error: true

      # Upload SARIF alla sezione "Code scanning alerts"
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec-results.sarif

      # OPTIONAL: aggiungo anche report JSON per archivio
      - name: Run GoSec (JSON)
        run: |
          ~/go/bin/gosec -fmt=json -out=gosec-report.json ./...
        continue-on-error: true

      - name: Upload GoSec JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: gosec-report
          path: gosec-report.json
          retention-days: 30
